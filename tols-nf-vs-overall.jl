using Printf;
using Plots;
gr();

include("./src/GaussNewton.jl");

NF_noise = [
    1.00000000e-02;
    6.81292069e-03;
    4.64158883e-03;
    3.16227766e-03;
    2.15443469e-03;
    1.46779927e-03;
    1.00000000e-03;
    6.81292069e-04;
    4.64158883e-04;
    3.16227766e-04;
    2.15443469e-04;
    1.46779927e-04;
    1.00000000e-04;
    6.81292069e-05;
    4.64158883e-05;
    3.16227766e-05;
    2.15443469e-05;
    1.46779927e-05;
    1.00000000e-05;
    6.81292069e-06;
    4.64158883e-06;
    3.16227766e-06;
    2.15443469e-06;
    1.46779927e-06;
    1.00000000e-06;
    6.81292069e-07;
    4.64158883e-07;
    3.16227766e-07;
    2.15443469e-07;
    1.46779927e-07;
    1.00000000e-07;
];

l2_tols = [
    8.12854032e-03  8.12854036e-03  8.12866071e-03;
    5.53799890e-03  5.53799895e-03  5.53817560e-03;
    3.77312513e-03  3.77312521e-03  3.77338448e-03;
    2.57079161e-03  2.57079174e-03  2.57117224e-03;
    1.75174082e-03  1.75174100e-03  1.75229938e-03;
    1.19385931e-03  1.19385958e-03  1.19467872e-03;
    8.13971553e-04  8.13971941e-04  8.15172913e-04;
    5.55438862e-04  5.55439431e-04  5.57197916e-04;
    3.79714029e-04  3.79714861e-04  3.82282530e-04;
    2.60591073e-04  2.60592285e-04  2.64319684e-04;
    1.80288578e-04  1.80290329e-04  1.85637172e-04;
    1.26771498e-04  1.26773989e-04  1.34269136e-04;
    9.18885681e-05  9.18920047e-05  1.01983808e-04;
    7.00223918e-05  7.00269014e-05  8.28270704e-05;
    5.70950041e-05  5.71005347e-05  7.22289951e-05;
    4.99708827e-05  4.99772017e-05  6.67403729e-05;
    4.62931071e-05  4.62999280e-05  6.40331165e-05;
    4.44828301e-05  4.44899286e-05  6.27368347e-05;
    4.36170510e-05  4.36242904e-05  6.21259639e-05;
    4.32092976e-05  4.32166053e-05  6.18403723e-05;
    4.30187220e-05  4.30260621e-05  6.17073634e-05;
    4.29299772e-05  4.29373324e-05  6.16455285e-05;
    4.28887231e-05  4.28960854e-05  6.16168063e-05;
    4.28695611e-05  4.28769267e-05  6.16034700e-05;
    4.28606640e-05  4.28680311e-05  6.15972789e-05;
    4.28565337e-05  4.28639016e-05  6.15944050e-05;
    4.28546165e-05  4.28619846e-05  6.15930711e-05;
    4.28537265e-05  4.28610949e-05  6.15924519e-05;
    4.28533135e-05  4.28606818e-05  6.15921645e-05;
    4.28531217e-05  4.28604901e-05  6.15920311e-05;
    4.28530327e-05  4.28604012e-05  6.15919691e-05;
];

op_tols = [
    8.95075337e-04  9.05583698e-04  9.05237437e-04;
    6.15911563e-04  6.11836258e-04  6.15981900e-04;
    4.20336586e-04  4.19191859e-04  4.20392319e-04;
    2.86585242e-04  2.84973193e-04  2.89777570e-04;
    1.94104550e-04  1.93211154e-04  1.94185382e-04;
    1.32327192e-04  1.33314957e-04  1.32012137e-04;
    9.00438562e-05  9.20576664e-05  9.08500918e-05;
    6.35872760e-05  6.36150794e-05  6.24967024e-05;
    4.96178798e-05  4.85080617e-05  4.94503422e-05;
    4.20148941e-05  4.01913282e-05  4.13572856e-05;
    3.73482735e-05  3.74330814e-05  3.81818883e-05;
    3.52896348e-05  3.54965126e-05  3.58607387e-05;
    3.49678281e-05  3.46765109e-05  3.50012013e-05;
    3.42955602e-05  3.42111342e-05  3.45810719e-05;
    3.41587597e-05  3.41206622e-05  3.44009084e-05;
    3.39883539e-05  3.39952828e-05  3.42849969e-05;
    3.39533428e-05  3.39335679e-05  3.41206948e-05;
    3.39347457e-05  3.39325632e-05  3.41897484e-05;
    3.39215645e-05  3.39205792e-05  3.40933210e-05;
    3.39356928e-05  3.39192383e-05  3.41256472e-05;
    3.39148716e-05  3.39211013e-05  3.40764201e-05;
    3.39272570e-05  3.39204649e-05  3.40756928e-05;
    3.39273059e-05  3.39244603e-05  3.40854032e-05;
    3.39242475e-05  3.39219404e-05  3.41573607e-05;
    3.39233341e-05  3.39228904e-05  3.41518174e-05;
    3.39219147e-05  3.39219952e-05  3.41303564e-05;
    3.39210910e-05  3.39207990e-05  3.41072654e-05;
    3.39222430e-05  3.39219630e-05  3.41131156e-05;
    3.39223051e-05  3.39221583e-05  3.41086860e-05;
    3.39217585e-05  3.39221830e-05  3.41026853e-05;
    3.39221930e-05  3.39219107e-05  3.41440440e-05;
]


FF_state = ["exact" "comp." "noised"]

plt =
plot(NF_noise, l2_tols, 
    label=map(s -> "Frobenius ($s)", FF_state), 
    linecolor=[:lightgreen :lightgreen :cadetblue],  
    xaxis=:log, xlabel="Near Field (element-wise) noise", xticks=10.0 .^ (-7:-2), xlims=(1e-7,1.4e-2),
    yaxis=:log, ylabel="Whole matrix relative error", yticks=10.0 .^ (-4.5:0.5:-2), ylims=(2.5e-5, 1.3e-2),
    legend=:topleft, size=(700,500));
plot!(NF_noise, op_tols, 
    label=map(s -> "Spectral ($s)", FF_state), 
    linecolor=[:coral :darkviolet :indigo]);

# function fitfn(x, β, out)
#     a = sqrt(1 + (x/β[2])^2);
#     out.y = β[1]*a;
#     out.d[1] = a;
#     out.d[2] = -β[1] * x^2 * β[2]^(-3) / a;
# end

# function fit(name, data, guess)
#     d = GaussNewton.createGNData(fitfn, NF_tols, data, guess);
#     println("Fitting of $name:");
#     (β, R²) = GaussNewton.solve(d, iterations=15, α=0.5);
#     @printf "R² = %.5f\nA  = %.4e\nn₀ = %.4e\n" R² β[1] β[2];
#     # println("R²       |  A           n₀");
#     # println("---------+----------------------")
#     # GaussNewton.track(d, iterations=15, α=0.5) do R², β
#     #     @printf "%.5f  |  %.4e  %.4e\n" R² β[1] β[2]
#     # end
# end

# fit("Frobenius (compressed)", l2_tols[:,2], [5e-5, 5e-5]);
# fit("Frobenius (noised)", l2_tols[:,3], [5e-5, 6e-5]);
# fit("Spectral (compressed)", op_tols[:,2], [4e-5, 3e-4]);

function inverseBode(A::Number) 
    return (x, β, out) -> begin
        s = sqrt(1 + (x/β[1])^2);
        out.y = A*s;
        out.d[1] = -A * x^2 * β[1]^(-3) / s;
    end
end

function fit2(name, data, fn, n₀)
    d = GaussNewton.createGNData(fn, NF_noise, data, [n₀]);
    println("Fitting of $name:");
    (β, R²) = GaussNewton.solve(d, iterations=15, α=0.5);
    @printf "R² = %.5f\nn₀ = %.6e\n" R² β[1];
    # println(" R²      |  n₀");
    # println("---------+-------------")
    # GaussNewton.track(d, iterations=15, α=0.5) do R², β
    #     @printf " %.5f | %.6e \n" R² β[1]
    # end
end

fit2("Frobenius (compressed)", l2_tols[:,2], inverseBode(4.28603241e-05), 5e-5);
fit2("Frobenius (noised)", l2_tols[:,3], inverseBode(6.15919155e-05), 6e-5);
fit2("Spectral (compressed)", op_tols[:,2], inverseBode(3.39219751e-05), 3.7e-4);